<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Equipamentos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="index.html">Equipamentos</a>
    <div>
      <a class="btn btn-outline-light me-2" href="novo.html">Novo</a>
      <a class="btn btn-outline-light" href="login.html">Login</a>
    </div>
  </div>
</nav>

<div class="container">
<h2>Equipamentos</h2>

<div class="d-flex mb-3">
  <input id="pesquisa" class="form-control me-2" placeholder="Pesquisar..." oninput="carregar()">
  <select id="ordenar" class="form-select w-auto" onchange="carregar()">
    <option value="aluno.asc">Aluno A→Z</option>
    <option value="aluno.desc">Aluno Z→A</option>
    <option value="numero.asc">Número ↑</option>
    <option value="numero.desc">Número ↓</option>
  </select>
</div>

<div id="tabela"></div>

<div class="mt-3">
  <button class="btn btn-secondary" onclick="anterior()">Anterior</button>
  <button class="btn btn-secondary" onclick="proximo()">Próximo</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
    "https://mnbvvmeveiipkwalashs.supabase.co",
    "sb_publishable_I2_Ssd4fUrbL_ht2u0Zf9g_p7cBAGP4"
);

let pagina = 0;
const tamanho = 5;

window.carregar = async function () {
  const termo = document.getElementById("pesquisa").value;
  const ordem = document.getElementById("ordenar").value.split(".");

  let query = supabase
    .from("equipamentos")
    .select("id, nome_aluno as aluno, numero_interno as numero")
    .order(ordem[0], { ascending: ordem[1] === "asc" })
    .range(pagina * tamanho, pagina * tamanho + tamanho - 1);

  if (termo) query = query.ilike("nome_aluno", `%${termo}%`);

  const { data, error } = await query;

  if (error) return alert(error.message);

  let html = `
    <table class="table table-striped">
      <tr>
        <th>Aluno</th>
        <th>Número</th>
        <th>Ações</th>
      </tr>
  `;

  data.forEach(row => {
    html += `
      <tr>
        <td>${row.aluno}</td>
        <td>${row.numero}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editar('${row.id}')">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="apagar('${row.id}')">Apagar</button>
        </td>
      </tr>
    `;
  });

  html += "</table>";

  document.getElementById("tabela").innerHTML = html;
};

window.anterior = function () {
  if (pagina > 0) pagina--;
  carregar();
};

window.proximo = function () {
  pagina++;
  carregar();
};

window.editar = function (id) {
  window.location.href = "editar.html?id=" + id;
};

window.apagar = async function (id) {
  if (!confirm("Apagar?")) return;

  await supabase.from("equipamentos").delete().eq("id", id);
  carregar();
};

carregar();
</script>
</div>
</body>
</html>
